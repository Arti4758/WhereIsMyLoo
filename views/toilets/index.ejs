<% layout('layouts/boilerplate') %>

<!-- Load page-specific CSS -->
<link rel="stylesheet" href="/css/index.css">

<!-- Search Section -->
<div class="search-card">
  <h3><i class="bi bi-geo-alt"></i> Find toilets near you</h3>
  <form method="GET" action="/toilets" id="location-form">
    <div class="search-row">
      <input type="text" 
        name="location" 
        id="location-input"
        placeholder="Enter address or use current location" 
        value="<%= location || '' %>" 
        class="search-input elongated-search-input">
      
      <!-- Mobile button wrapper -->
      <div class="mobile-button-row">
        <button type="button" id="use-location" class="gps-button">
          üìç Use My Location
        </button>
        <button type="submit" class="search-button">
          üîç Search
        </button>
      </div>
    </div>
    
    <div class="search-filters-row">
      <!-- Paid/Free/All toggle -->
      <div class="paid-toggle-group">
        <input type="radio" id="paid-all" name="paid" value="" <%= !paid ? "checked" : "" %> onchange="this.form.submit()">
        <label for="paid-all">All</label>
        <input type="radio" id="paid-true" name="paid" value="true" <%= paid === "true" ? "checked" : "" %> onchange="this.form.submit()">
        <label for="paid-true">Paid</label>
        <input type="radio" id="paid-false" name="paid" value="false" <%= paid === "false" ? "checked" : "" %> onchange="this.form.submit()">
        <label for="paid-false">Free</label>
      </div>
      
      <!-- Review filter -->
      <div class="review-filter-group">
        <select name="minRating" id="min-rating-filter" class="search-input" onchange="this.form.submit()">
          <option value="">All Reviews</option>
          <option value="5" <%= minRating == 5 ? "selected" : "" %>>5‚òÖ only</option>
          <option value="4" <%= minRating == 4 ? "selected" : "" %>>4‚òÖ & up</option>
          <option value="3" <%= minRating == 3 ? "selected" : "" %>>3‚òÖ & up</option>
          <option value="2" <%= minRating == 2 ? "selected" : "" %>>2‚òÖ & up</option>
        </select>
      </div>
    </div>
    

    <!-- Auto-suggestions dropdown -->
    <div id="suggestions" style="display: none; background: white; border: 1px solid #ccc; border-radius: 4px; margin-top: 0.5rem;">
    </div>
  </form>
</div>

<!-- Results -->
<div class="toilet-grid">
  <% if (toilets.length === 0) { %>
    <div class="no-toilets">
      <p>
      üö´ No toilets found.<br>
      <a href="/toilets/new" class="add-link">Add the first one!</a>
      </p>
    </div>
  <% } else { %>
    <% toilets.forEach(toilet => { %>
      <div class="toilet-card">
        <img src="<%= toilet.images.length ? toilet.images[0].url : 'https://placehold.co/600x400' %>" 
             class="toilet-image" alt="<%= toilet.title %>">
        
        <div class="toilet-card-content">
          <h3 class="toilet-title"><%= toilet.title %></h3>
          
          <p class="toilet-location">
            <i class="bi bi-geo-alt"></i> <%= toilet.location %>
          </p>
          
          <% if (toilet.distance) { %>
            <p class="toilet-distance">
              <i class="bi bi-pin-map"></i> <%= toilet.distance %> km away
            </p>
          <% } %>
          
          <div class="toilet-features">
            <span class="feature-badge <%= toilet.isPaid ? 'paid' : 'free' %>">
              <%= toilet.isPaid ? `‚Çπ${toilet.price}` : 'Free' %>
            </span>
            <span class="feature-badge"><%= toilet.genderAccess %></span>
            <% if (toilet.isAccessible) { %>
              <span class="feature-badge">‚ôø Accessible</span>
            <% } %>
          </div>
          
          <a href="/toilets/<%= toilet._id %>" class="view-button">
            View Details
          </a>
        </div>
      </div>
    <% }) %>
  <% } %>
</div>

<!-- Load JavaScript -->
<script src="/js/location-helper.js"></script>
<script>
  const locationHelper = new LocationHelper('location-input', 'suggestions', 'use-location');
  
  const originalReverseGeocode = locationHelper.reverseGeocode.bind(locationHelper);
  locationHelper.reverseGeocode = async function(lat, lng) {
    await originalReverseGeocode(lat, lng);
    if (this.inputElement.value) {
      document.getElementById('location-form').submit();
    }
  };
</script>