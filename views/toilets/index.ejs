<% layout('layouts/boilerplate') %>

<!-- Load page-specific CSS -->
<link rel="stylesheet" href="/css/index.css">
<!-- Search Section -->
<div class="search-card">
  <h3>üîç Find toilets near you</h3>
  <form method="GET" action="/toilets" id="location-form">
    <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
      <input type="text" 
       name="location" 
       id="location-input"
       placeholder="Enter address or use current location" 
       value="<%= location || '' %>" 
       class="search-input">
            <select name="paid" id="paid-filter" class="search-input" onchange="document.getElementById('location-form').submit()">
              <option value="">All</option>
              <option value="true" <%= paid === "true" ? "selected" : "" %>>Paid</option>
              <option value="false" <%= paid === "false" ? "selected" : "" %>>Free</option>
            </select>
            <input type="number" name="minRating" id="min-rating-filter" class="search-input" min="1" max="5" step="1" placeholder="Min Cleanliness Rating" value="<%= minRating || '' %>" oninput="document.getElementById('location-form').submit()">
            <button type="button" id="use-location" class="gps-button">
              üìç Use My Location
            </button>
            
            <button type="submit" class="search-button">
              üîç Search
            </button>
    </div>
    
    <!-- Auto-suggestions dropdown -->
    <div id="suggestions" style="display: none; background: white; border: 1px solid #ccc; border-radius: 4px; margin-top: 0.5rem;">
    </div>
  </form>
</div>

<!-- Results -->
<div class="toilet-grid">
  <% if (toilets.length === 0) { %>
    <div class="no-toilets">
      <p>
      üö´ No toilets found.<br>
      <a href="/toilets/new" class="add-link">Add the first one!</a>
      </p>
    </div>
  <% } else { %>
    <% toilets.forEach(toilet => { %>
      <div class="toilet-card">
        <img src="<%= toilet.images.length ? toilet.images[0].url : 'https://placehold.co/600x400' %>" 
             class="toilet-image" alt="<%= toilet.title %>">
        
        <div class="toilet-card-content">
          <h3 class="toilet-title"><%= toilet.title %></h3>
          
          <p class="toilet-location">
            <i class="bi bi-geo-alt"></i> <%= toilet.location %>
          </p>
          
          <% if (toilet.distance) { %>
            <p class="toilet-distance">
              <i class="bi bi-pin-map"></i> <%= toilet.distance %> km away
            </p>
          <% } %>
          
          <div class="toilet-features">
            <span class="feature-badge <%= toilet.isPaid ? 'paid' : 'free' %>">
              <%= toilet.isPaid ? `‚Çπ${toilet.price}` : 'Free' %>
            </span>
            <span class="feature-badge"><%= toilet.genderAccess %></span>
            <% if (toilet.isAccessible) { %>
              <span class="feature-badge">‚ôø Accessible</span>
            <% } %>
          </div>
          
          <a href="/toilets/<%= toilet._id %>" class="view-button">
            View Details
          </a>
        </div>
      </div>
    <% }) %>
  <% } %>
</div>

<!-- Load JavaScript -->
<script src="/js/location-helper.js"></script>
<script>
  const locationHelper = new LocationHelper('location-input', 'suggestions', 'use-location');
  
  const originalReverseGeocode = locationHelper.reverseGeocode.bind(locationHelper);
  locationHelper.reverseGeocode = async function(lat, lng) {
    await originalReverseGeocode(lat, lng);
    if (this.inputElement.value) {
      document.getElementById('location-form').submit();
    }
  };
</script>